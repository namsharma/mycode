(function ($) {

    // ------- helpers -------

    function getFormInput($form) {
        return $form
            .find('.search-box-input.searchbar__input.js-search-hero-input.tt-input')
            .eq(0);
    }

    function isValid($form) {
        var $input = getFormInput($form);
        if (!$input.length) return false;

        var currentValue = $.trim($input.val());

        // last submitted value for THIS form
        var lastValue = $form.data('lastValue') || "";

        // must be non-empty and not the same as last submitted value
        return currentValue !== "" && currentValue !== lastValue;
    }

    function updateButtonState($form) {
        var $btn = $form.find('.search-box-button');
        $btn.prop('disabled', !isValid($form));
    }

    function setLastValue($form, value) {
        $form.data('lastValue', value);

        // also persist globally for next page load
        try {
            if (window.sessionStorage) {
                sessionStorage.setItem('fisLastSearch', value);
            }
        } catch (e) {
            // ignore storage errors
        }
    }

    function getInitialLastValue() {
        var last = "";

        try {
            // 1) from URL: ?textBoxSearch=...
            var params = new URLSearchParams(window.location.search);
            last = params.get('textBoxSearch') || "";

            // 2) fall back to sessionStorage if URL has nothing
            if (!last && window.sessionStorage) {
                last = sessionStorage.getItem('fisLastSearch') || "";
            }
        } catch (e) {
            // ignore
        }

        return $.trim(last || "");
    }

    // ------- initialisation on page load -------

    $(function () {
        var initialLast = getInitialLastValue();

        $('.searchbar__form').each(function () {
            var $form = $(this);
            $form.data('initialized', true);
            $form.data('lastValue', initialLast);
            updateButtonState($form); // in case inputs are prefilled
        });
    });

    // ------- events -------

    // focus: just ensure button state is correct
    $(document).on(
        'focus',
        '.search-box-input.searchbar__input.js-search-hero-input.tt-input',
        function () {
            var $form = $(this).closest('.searchbar__form');

            if (!$form.data('initialized')) {
                $form.data('initialized', true);
                $form.data('lastValue', getInitialLastValue());
            }

            updateButtonState($form);
        }
    );

    // typing: enable/disable button live
    $(document).on(
        'input keyup change',
        '.search-box-input.searchbar__input.js-search-hero-input.tt-input',
        function () {
            var $form = $(this).closest('.searchbar__form');
            updateButtonState($form);
        }
    );

    // ENTER in input: block if empty OR same as last value
    $(document).on(
        'keydown',
        '.search-box-input.searchbar__input.js-search-hero-input.tt-input',
        function (e) {
            if (e.key === 'Enter' || e.keyCode === 13) {
                var $form = $(this).closest('.searchbar__form');

                if (!isValid($form)) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    console.log('Enter blocked: empty or same value');
                    return false;
                }
            }
        }
    );

    // form submit: final guard (covers both header + hero forms)
    $(document).on('submit', '.searchbar__form', function (e) {
        var $form = $(this);

        if (!isValid($form)) {
            e.preventDefault();
            e.stopImmediatePropagation();
            console.log('Search blocked: empty or same value (submit)');
            return false;
        }

        var $input = getFormInput($form);
        var val = $.trim($input.val());

        // remember this value so the same query can't be fired again
        setLastValue($form, val);

        // disable only THIS form's button
        $form.find('.search-box-button').prop('disabled', true);
    });

    // button click: same validation as submit
    $(document).on('click', '.search-box-button', function (e) {
        var $form = $(this).closest('.searchbar__form');

        if (!isValid($form)) {
            e.preventDefault();
            e.stopImmediatePropagation();
            console.log('Button click blocked: empty or same value');
            return false;
        }
    });

})(jQuery);
