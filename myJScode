(function ($) {
    function getFormInput($form) {
        return $form
            .find('.search-box-input.searchbar__input.js-search-hero-input.tt-input')
            .eq(0);
    }

    function isValid($form) {
        var $input = getFormInput($form);
        if (!$input.length) return false;

        var currentValue = $.trim($input.val());
        var lastValue = $form.data('lastValue') || "";

        // must be non-empty and not same as last submitted value
        return currentValue !== "" && currentValue !== lastValue;
    }

    function updateButtonState($form) {
        var $btn = $form.find('.search-box-button');
        $btn.prop('disabled', !isValid($form));
    }

    // When input gets focus, initialize per-form state
    $(document).on(
        'focus',
        '.search-box-input.searchbar__input.js-search-hero-input.tt-input',
        function () {
            var $form = $(this).closest('.searchbar__form');

            if (!$form.data('initialized')) {
                $form.data('lastValue', "");
                $form.data('initialized', true);
            }

            updateButtonState($form);
        }
    );

    // On typing / changing value, update the correct form's button
    $(document).on(
        'input keyup change',
        '.search-box-input.searchbar__input.js-search-hero-input.tt-input',
        function () {
            var $form = $(this).closest('.searchbar__form');
            updateButtonState($form);
        }
    );

    // Block Enter key in the input when invalid
    $(document).on(
        'keydown',
        '.search-box-input.searchbar__input.js-search-hero-input.tt-input',
        function (e) {
            if (e.key === 'Enter' || e.keyCode === 13) {
                var $form = $(this).closest('.searchbar__form');

                if (!isValid($form)) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    console.log('Enter blocked: empty or same value');
                    return false;
                }
            }
        }
    );

    // Block form submit when invalid (covers both forms)
    $(document).on('submit', '.searchbar__form', function (e) {
        var $form = $(this);

        if (!isValid($form)) {
            e.preventDefault();
            e.stopImmediatePropagation();
            console.log('Search blocked: empty or same value (submit)');
            return false;
        }

        var $input = getFormInput($form);
        $form.data('lastValue', $.trim($input.val()));

        // Disable only this form's button
        $form.find('.search-box-button').prop('disabled', true);
    });

    // Block button click when invalid
    $(document).on('click', '.search-box-button', function (e) {
        var $form = $(this).closest('.searchbar__form');

        if (!isValid($form)) {
            e.preventDefault();
            e.stopImmediatePropagation();
            console.log('Button click blocked: empty or same value');
            return false;
        }
    });

})(jQuery);
