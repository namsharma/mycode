(function ($) {

    // ------- helpers -------

    function getFormInput($form) {
        return $form
            .find('.search-box-input.searchbar__input.js-search-hero-input.tt-input')
            .eq(0);
    }

    function getLastValue($form) {
        // per-form value if we already have it
        var local = $form.data('lastValue');
        if (typeof local !== 'undefined') {
            return local;
        }

        // otherwise check sessionStorage (shared across forms/pages)
        var global = "";
        try {
            if (window.sessionStorage) {
                global = sessionStorage.getItem('fisLastSearch') || "";
            }
        } catch (e) {}
        return $.trim(global || "");
    }

    function setLastValue($form, value) {
        $form.data('lastValue', value);
        try {
            if (window.sessionStorage) {
                sessionStorage.setItem('fisLastSearch', value);
            }
        } catch (e) {}
    }

    function isValid($form) {
        var $input = getFormInput($form);
        if (!$input.length) return false;

        var currentValue = $.trim($input.val());
        var lastValue    = getLastValue($form);

        // must be non-empty and not same as last submitted
        return currentValue !== "" && currentValue !== lastValue;
    }

    function updateButtonState($form) {
        var $btn = $form.find('.search-box-button');
        $btn.prop('disabled', !isValid($form));
    }

    // ------- events -------

    // typing: toggle button state live
    $(document).on(
        'input keyup change',
        '.search-box-input.searchbar__input.js-search-hero-input.tt-input',
        function () {
            var $form = $(this).closest('.searchbar__form');
            updateButtonState($form);
        }
    );

    // form submit: final guard
    $(document).on('submit', '.searchbar__form', function (e) {
        var $form = $(this);

        if (!isValid($form)) {
            e.preventDefault();
            e.stopImmediatePropagation();
            console.log('Search blocked: empty or same value (submit)');
            return false;
        }

        var $input = getFormInput($form);
        var val    = $.trim($input.val());

        // remember this value
        setLastValue($form, val);

        // disable only THIS form's button
        $form.find('.search-box-button').prop('disabled', true);
    });

    // button click: same validation as submit
    $(document).on('click', '.search-box-button', function (e) {
        var $form = $(this).closest('.searchbar__form');

        if (!isValid($form)) {
            e.preventDefault();
            e.stopImmediatePropagation();
            console.log('Button click blocked: empty or same value (click)');
            return false;
        }
    });

    // capture-phase handler for Enter: blocks other scripts from acting first
    ['keydown', 'keypress'].forEach(function (type) {
        document.addEventListener(
            type,
            function (e) {
                var target = e.target;

                if (
                    !target.matches ||
                    !target.matches('.search-box-input.searchbar__input.js-search-hero-input.tt-input')
                ) {
                    return;
                }

                if (e.key === 'Enter' || e.keyCode === 13) {
                    var $form = $(target).closest('.searchbar__form');

                    if (!isValid($form)) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Enter blocked (capture): empty or same value');
                    }
                }
            },
            true // capture phase
        );
    });

})(jQuery);
